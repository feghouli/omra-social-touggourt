<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>التحقق من رقم التعريف الوظيفي للموظف</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, #6a11cb, #2575fc);
      display: flex; justify-content: center; align-items: center;
      min-height: 100vh; padding: 15px; overflow-x: hidden; margin: 0; position: relative;
    }
    .container {
      position: relative; background: white; padding: 35px 25px;
      border-radius: 18px; box-shadow: 0 15px 40px rgba(0,0,0,0.2);
      text-align: center; width: 100%; max-width: 350px; margin: 0 auto; z-index: 1;
    }
    h2 { margin-bottom: 20px; font-weight: 700; font-size: 22px; color: #333; }
    input, select {
      width: 100%; padding: 14px 18px; margin-bottom: 18px;
      border-radius: 10px; border: 2px solid #e0e0e0;
      font-size: 15px; text-align: center; font-family: 'Cairo', sans-serif; font-weight: 500;
      transition: none !important;
      box-shadow: none !important;
    }
    input:focus, select:focus {
      outline: none; border-color: #2575fc;
      box-shadow: none !important;
    }
    #empId {
      transition: none !important;
      transform: none !important;
    }
    button {
      background: linear-gradient(45deg, #6a11cb, #2575fc);
      color: white; border: none; padding: 14px 0; border-radius: 10px;
      font-size: 15px; cursor: pointer; font-weight: 600; width: 100%;
      transition: none !important;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      font-family: 'Cairo', sans-serif;
    }
    button:hover { transform: none; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
  </style>
</head>
<body>

<div class="container" id="mainContainer">
  <h2>التحقق من رقم التعريف الوظيفي للموظف</h2>
  <input type="text" id="empId" placeholder="أدخل رقم التعريف الوظيفي" oninput="validateNumber(this)">
  <button onclick="checkEmployee()">تحقق</button>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDLXP89rGzbTMCL8z33ETk1q7JYKsNo3jA",
    authDomain: "omra-c21a8.firebaseapp.com",
    projectId: "omra-c21a8",
    storageBucket: "omra-c21a8.appspot.com",
    messagingSenderId: "345175863295",
    appId: "1:345175863295:web:ac26e1ee0460db6c6041ca",
    measurementId: "G-RSMC9G22D6"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const scriptURL = "https://script.google.com/macros/s/AKfycbxkfP7iKT53kLz85dmxV7KL4PvNk60FWgcmVxq4Qtj1ehZTYJM3cwarWf-7ng7omnKQ/exec";

  function validateNumber(input) {
    input.value = input.value.replace(/\D/g, '');
    if (input.value.length > 15) input.value = input.value.slice(0, 15);
  }

  async function checkEmployee() {
    const empId = document.getElementById("empId").value.trim();
    if (empId.length !== 15) {
      Swal.fire("تنبيه", "رقم التعريف يجب أن يتكون من 16 رقمًا", "warning");
      return;
    }

    try {
      const docRef = db.collection("employees").doc(empId);
      const docSnap = await docRef.get();

      if (docSnap.exists) {
        const data = docSnap.data();
        Swal.fire({
          title: "✅ تم التحقق بنجاح",
          html: `<b>الاسم واللقب:</b> ${data.name}<br><b>الرتبة:</b> ${data.grade}<br><b>مكان العمل:</b> ${data.place}`,
          icon: "success",
          confirmButtonText: "متابعة التسجيل"
        }).then(() => showForm(empId, data));
      } else {
        Swal.fire("❌ خطأ", "رقم الموظف غير موجود في قاعدة البيانات", "error");
      }
    } catch (err) {
      console.error(err);
      Swal.fire("خطأ", "حدث خطأ أثناء الاتصال بقاعدة البيانات أعد المحاولة", "error");
    }
  }

  function showForm(empId, data) {
    const container = document.getElementById("mainContainer");
    container.innerHTML = `
      <h2>استمارة التسجيل</h2>
      <input type="text" id="empIdField" value="${empId}" readonly>
      <input type="text" id="nameField" value="${data.name}" readonly>
      <input type="text" id="gradeField" value="${data.grade}" readonly>
      <input type="text" id="placeField" value="${data.place}" readonly>

      <select id="daairaField" onchange="updateBaladiya()">
        <option value="">اختر دائرة العمل</option>
        <option value="توقرت">توقرت</option>
        <option value="تماسين">تماسين</option>
        <option value="المقارين">المقارين</option>
        <option value="الحجيرة">الحجيرة</option>
        <option value="الطيبات">الطيبات</option>
      </select>

      <select id="baladiyaField">
        <option value="">اختر بلدية العمل</option>
      </select>

      <input type="text" id="phoneField" placeholder="رقم الهاتف (10 أرقام)" oninput="validatePhone(this)">
      <button id="submitBtn" onclick="submitForm()">تسجيل</button>
    `;
    window.baladiyaMap = {
      "توقرت": ["توقرت", "النزلة", "تبسبست", "الزاوية العابدية"],
      "تماسين": ["تماسين", "بلدة عمر"],
      "المقارين": ["المقارين", "سيدي سليمان"],
      "الحجيرة": ["الحجيرة", "العالية"],
      "الطيبات": ["المنقر", "ابن ناصر"]
    };
  }

  function updateBaladiya() {
    const daaira = document.getElementById("daairaField").value;
    const baladiyaSelect = document.getElementById("baladiyaField");
    baladiyaSelect.innerHTML = '<option value="">اختر بلدية العمل</option>';
    if (daaira && window.baladiyaMap[daaira]) {
      window.baladiyaMap[daaira].forEach(b => {
        const option = document.createElement("option");
        option.value = b;
        option.text = b;
        baladiyaSelect.add(option);
      });
    }
  }

  function validatePhone(input) {
    input.value = input.value.replace(/\D/g, '');
    if (input.value.length > 10) input.value = input.value.slice(0, 10);
  }

  async function submitForm() {
    const submitBtn = document.getElementById("submitBtn");
    submitBtn.disabled = true;
    submitBtn.style.opacity = 0.6;

    const empId = document.getElementById("empIdField").value;
    const name = document.getElementById("nameField").value;
    const grade = document.getElementById("gradeField").value;
    const place = document.getElementById("placeField").value;
    const daaira = document.getElementById("daairaField").value.trim();
    const baladiya = document.getElementById("baladiyaField").value.trim();
    const phone = document.getElementById("phoneField").value.trim();
    
    if (phone.length !== 10) {
      Swal.fire("تنبيه", "رقم الهاتف يجب أن يحتوي على 10 أرقام", "warning");
      submitBtn.disabled = false;
      submitBtn.style.opacity = 1;
      return;
    }
    if (!daaira || !baladiya) {
      Swal.fire("تنبيه", "الرجاء إدخال دائرة وبلدية العمل", "warning");
      submitBtn.disabled = false;
      submitBtn.style.opacity = 1;
      return;
    }

    const formData = new FormData();
    formData.append("empId", empId);
    formData.append("name", name);
    formData.append("grade", grade);
    formData.append("place", place);
    formData.append("daaira", daaira);
    formData.append("baladiya", baladiya);
    formData.append("phone", phone);

    Swal.fire({
      title: 'جاري تسجيل البيانات...',
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
    });

    try {
      const res = await fetch(scriptURL, { method: "POST", body: formData });
      const data = await res.json();

      if (data.result === "success") {
        Swal.fire("✅ تم التسجيل بنجاح", "تم تسجيل اسمك في قرعة العمرة بنجاح بالتوفيق إن شاء الله", "success")
          .then(() => location.reload());
      } else if (data.result === "exists") {
        const d = data.data;
        Swal.fire({
          title: "⚠️ التسجيل موجود مسبقًا",
          html: `<b>رقم التعريف:</b> ${d.empId}<br>
                 <b>الاسم واللقب:</b> ${d.name}<br>
                 <b>الرتبة:</b> ${d.grade}<br>
                 <b>مكان العمل:</b> ${d.place}<br>
                 <b>دائرة العمل:</b> ${d.daaira}<br>
                 <b>بلدية العمل:</b> ${d.baladiya}<br>
                 <b> رقم الهاتف:</b> ${d.phone}`,
          icon: "warning",
          confirmButtonText: "حسنًا"
        }).then(() => location.reload());
      } else {
        Swal.fire("❌ خطأ", "تعذر إرسال البيانات", "error");
        submitBtn.disabled = false;
        submitBtn.style.opacity = 1;
      }
    } catch (error) {
      Swal.fire("❌ خطأ", "فشل الاتصال بخدمة التسجيل", "error");
      submitBtn.disabled = false;
      submitBtn.style.opacity = 1;
    }
  }
</script>
</body>
</html>

